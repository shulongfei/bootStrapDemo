/**
 * Created by shu on 2019/1/15.
 */
/**
 *学生管理相关的模块
 */
const pool = require('../lib/pool');



module.exports = {

  login: function(req, res){
    const name = req.fields.name;
    const password = req.fields.password;
    // 校验参数
    try {
      if (!name.length) {
        console.log(11111);
        throw new Error('请填写用户名');
      }
      if (!password.length) {
        throw new Error('请填写密码');
      }
    } catch (e) {
      req.flash('error', e.message);
      return res.redirect('back')
    }
    pool.getConnection((err, conn)=>{
      conn.query('select * from user where user.name = ?', [name], (err, result)=>{
        res.setHeader('Content-Type','text/html;charset=UTF-8');
        if (result.length === 0) {
          req.flash('error', '用户不存在');
          return res.redirect('back');
        }
        // 检查密码是否匹配
        if (password !== result[0].password) {
          req.flash('error', '用户名或密码错误');
          return res.redirect('back')
        }
        delete result[0].password;
        req.session.user = result[0];
        // 跳转到主页
        res.redirect('/posts');

        conn.release();
      });
    });

  },

  //向客户端输出所有的学生信息，以JSON格式
  list: function(req, res){

  }
};
